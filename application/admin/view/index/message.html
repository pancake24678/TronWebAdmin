<style>
    /* æ¶ˆæ¯é€šçŸ¥å®¹å™¨ */
    .notification-container {
        position: fixed;
        top: 50px;
        right: 20px;
        width: 380px;
        max-width: calc(100vw - 40px);
        z-index: 9999;
        pointer-events: none;
    }

    /* æ¶ˆæ¯å¡ç‰‡ */
    .notification-card {
        position: relative;
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        pointer-events: auto;
        overflow: hidden;
        border-left: 5px solid #667eea;
    }

    /* å¡ç‰‡è¿›å…¥åŠ¨ç”» - ä»å³ä¾§æ»‘å…¥ */
    .notification-enter {
        transform: translateX(100%) translateY(0);
        opacity: 0;
    }

    .notification-enter-active {
        transform: translateX(0) translateY(0);
        opacity: 1;
    }

    /* å¡ç‰‡ç¦»å¼€åŠ¨ç”» - å‘ä¸Šæ»‘å‡º */
    .notification-exit {
        transform: translateX(0) translateY(0);
        opacity: 1;
    }

    .notification-exit-active {
        transform: translateX(0) translateY(-100%);
        opacity: 0;
    }

    /* å¡ç‰‡ç±»å‹æ ·å¼ */
    .notification-success {
        border-left-color: #10b981;
        background: linear-gradient(90deg, #f0fdf4 0%, white 20%);
    }

    .notification-warning {
        border-left-color: #f59e0b;
        background: linear-gradient(90deg, #fffbeb 0%, white 20%);
    }

    .notification-error {
        border-left-color: #ef4444;
        background: linear-gradient(90deg, #fef2f2 0%, white 20%);
    }

    .notification-info {
        border-left-color: #3b82f6;
        background: linear-gradient(90deg, #eff6ff 0%, white 20%);
    }

    /* å¡ç‰‡å¤´éƒ¨ */
    .notification-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
    }

    .notification-title {
        font-weight: 600;
        font-size: 16px;
        color: #1f2937;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .notification-icon {
        font-size: 18px;
    }

    .notification-close {
        background: none;
        border: none;
        color: #9ca3af;
        font-size: 20px;
        cursor: pointer;
        padding: 0;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: all 0.2s;
    }

    .notification-close:hover {
        background: #f3f4f6;
        color: #374151;
    }

    /* å¡ç‰‡å†…å®¹ */
    .notification-content {
        color: #4b5563;
        line-height: 1.5;
        font-size: 14px;
        margin-bottom: 10px;
    }

    .notification-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 12px;
        color: #9ca3af;
    }

    .notification-time {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .notification-sender {
        font-weight: 500;
    }

    /* è¿›åº¦æ¡ */
    .notification-progress {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: #e5e7eb;
        overflow: hidden;
    }

    .notification-progress-bar {
        height: 100%;
        background: #667eea;
        width: 100%;
        transform-origin: left;
        transition: transform 0.1s linear;
    }

    /* æ¶ˆæ¯è®¡æ•° */
    .notification-count {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #ef4444;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
        z-index: 10000;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.1);
        }

        100% {
            transform: scale(1);
        }
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
        .notification-container {
            width: calc(100vw - 40px);
            right: 20px;
            left: 20px;
        }

        .notification-card {
            padding: 16px;
        }
    }
</style>
<!-- æ¶ˆæ¯é€šçŸ¥å®¹å™¨ -->
<div class="notification-container" id="notificationContainer"></div>
<script>
    class NotificationManager {
        constructor() {
            this.container = document.getElementById('notificationContainer');
            this.notifications = [];
            this.maxVisible = 5; // æœ€å¤§åŒæ—¶æ˜¾ç¤ºæ•°é‡
            this.visibleCount = 0;
            this.idCounter = 0;

            // åˆå§‹åŒ–å®¹å™¨
            this.initContainer();
        }

        initContainer() {
            // ç¡®ä¿å®¹å™¨å­˜åœ¨
            if (!this.container) {
                this.container = document.createElement('div');
                this.container.className = 'notification-container';
                document.body.appendChild(this.container);
            }

            // ç›‘å¬çª—å£å˜åŒ–
            window.addEventListener('resize', () => this.updatePositions());
        }

        /**
         * æ˜¾ç¤ºæ–°æ¶ˆæ¯
         * @param {Object} options æ¶ˆæ¯é…ç½®
         * @param {string} options.title æ ‡é¢˜
         * @param {string} options.content å†…å®¹
         * @param {string} options.type ç±»å‹: info|success|warning|error
         * @param {string} options.sender å‘é€è€…
         * @param {number} options.duration æ˜¾ç¤ºæ—¶é•¿(ms)ï¼Œé»˜è®¤30000
         * @param {Function} options.onClose å…³é—­å›è°ƒ
         * @returns {string} æ¶ˆæ¯ID
         */
        show(options) {
            const id = `notification_${Date.now()}_${++this.idCounter}`;

            const notification = {
                id,
                title: options.title || 'æ–°æ¶ˆæ¯',
                content: options.content || 'æ‚¨æœ‰ä¸€æ¡æ–°æ¶ˆæ¯',
                type: options.type || 'info',
                sender: options.sender || 'ç³»ç»Ÿ',
                duration: options.duration || 30000, // 30ç§’
                createdAt: Date.now(),
                onClose: options.onClose,
                element: null,
                timer: null,
                progressTimer: null,
                remainingTime: options.duration || 30000
            };

            // æ·»åŠ åˆ°é˜Ÿåˆ—
            this.notifications.unshift(notification);

            // åˆ›å»ºå¡ç‰‡å…ƒç´ 
            this.createNotificationElement(notification);

            // å®‰æ’æ˜¾ç¤º
            this.scheduleNotification(notification);

            // æ›´æ–°å¸ƒå±€
            this.updatePositions();

            return id;
        }

        /**
         * åˆ›å»ºæ¶ˆæ¯å¡ç‰‡å…ƒç´ 
         */
        createNotificationElement(notification) {
            const element = document.createElement('div');
            element.className = `notification-card notification-${notification.type} notification-enter`;
            element.dataset.id = notification.id;

            // å›¾æ ‡æ˜ å°„
            const icons = {
                info: 'â„¹ï¸',
                success: 'âœ…',
                warning: 'âš ï¸',
                error: 'âŒ'
            };

            // è®¡ç®—å‰©ä½™æ—¶é—´ç™¾åˆ†æ¯”
            const progressPercent = (notification.remainingTime / notification.duration) * 100;

            element.innerHTML = `
                    <div class="notification-header">
                        <div class="notification-title">
                            <span class="notification-icon">${icons[notification.type] || 'ğŸ“¢'}</span>
                            ${notification.title}
                        </div>
                        <button class="notification-close" onclick="notificationManager.closeNotification('${notification.id}')">
                            Ã—
                        </button>
                    </div>
                    <div class="notification-content">
                        ${notification.content}
                    </div>
                    <div class="notification-meta">
                        <div class="notification-sender">æ¥è‡ª: ${notification.sender}</div>
                        <div class="notification-time">
                            <span>${Math.ceil(notification.remainingTime / 1000)}ç§’åæ¶ˆå¤±</span>
                        </div>
                    </div>
                    <div class="notification-progress">
                        <div class="notification-progress-bar" style="transform: scaleX(${progressPercent / 100})"></div>
                    </div>
                `;

            notification.element = element;

            // æ·»åŠ åˆ°å®¹å™¨
            this.container.appendChild(element);

            // è§¦å‘è¿›å…¥åŠ¨ç”»
            setTimeout(() => {
                element.classList.remove('notification-enter');
                element.classList.add('notification-enter-active');
            }, 10);

            // å¼€å§‹è¿›åº¦æ¡åŠ¨ç”»
            this.startProgressBar(notification);
        }

        /**
         * å¼€å§‹è¿›åº¦æ¡åŠ¨ç”»
         */
        startProgressBar(notification) {
            if (notification.progressTimer) {
                clearInterval(notification.progressTimer);
            }

            const progressBar = notification.element.querySelector('.notification-progress-bar');
            if (!progressBar) return;

            const startTime = Date.now();
            const duration = notification.remainingTime;

            notification.progressTimer = setInterval(() => {
                const elapsed = Date.now() - startTime;
                const remaining = Math.max(0, duration - elapsed);
                const percent = (remaining / duration) * 100;

                // æ›´æ–°è¿›åº¦æ¡
                progressBar.style.transform = `scaleX(${percent / 100})`;

                // æ›´æ–°æ—¶é—´æ˜¾ç¤º
                const timeElement = notification.element.querySelector('.notification-time span');
                if (timeElement) {
                    timeElement.textContent = `${Math.ceil(remaining / 1000)}ç§’åæ¶ˆå¤±`;
                }

                // ä¿å­˜å‰©ä½™æ—¶é—´ç”¨äºæš‚åœ/æ¢å¤
                notification.remainingTime = remaining;

                if (remaining <= 0) {
                    clearInterval(notification.progressTimer);
                }
            }, 100);
        }

        /**
         * å®‰æ’æ¶ˆæ¯æ˜¾ç¤º
         */
        scheduleNotification(notification) {
            // è®¾ç½®è‡ªåŠ¨å…³é—­å®šæ—¶å™¨
            notification.timer = setTimeout(() => {
                this.closeNotification(notification.id);
            }, notification.remainingTime);
        }

        /**
         * å…³é—­æŒ‡å®šæ¶ˆæ¯
         * @param {string} id æ¶ˆæ¯ID
         */
        closeNotification(id) {
            const index = this.notifications.findIndex(n => n.id === id);
            if (index === -1) return;

            const notification = this.notifications[index];

            // æ¸…ç†å®šæ—¶å™¨
            if (notification.timer) {
                clearTimeout(notification.timer);
            }
            if (notification.progressTimer) {
                clearInterval(notification.progressTimer);
            }

            // è§¦å‘ç¦»å¼€åŠ¨ç”»
            if (notification.element) {
                notification.element.classList.remove('notification-enter-active');
                notification.element.classList.add('notification-exit');
                notification.element.classList.add('notification-exit-active');

                // åŠ¨ç”»å®Œæˆåç§»é™¤å…ƒç´ 
                setTimeout(() => {
                    if (notification.element && notification.element.parentNode) {
                        notification.element.parentNode.removeChild(notification.element);
                    }
                }, 500);
            }

            // ä»æ•°ç»„ä¸­ç§»é™¤
            this.notifications.splice(index, 1);

            // è§¦å‘å…³é—­å›è°ƒ
            if (notification.onClose) {
                notification.onClose();
            }

            // æ›´æ–°å¸ƒå±€
            setTimeout(() => this.updatePositions(), 500);
        }

        /**
         * æ¸…ç©ºæ‰€æœ‰æ¶ˆæ¯
         */
        clearAll() {
            // ä»åå¾€å‰å…³é—­ï¼Œé¿å…æ•°ç»„ç´¢å¼•å˜åŒ–
            for (let i = this.notifications.length - 1; i >= 0; i--) {
                this.closeNotification(this.notifications[i].id);
            }
        }

        /**
         * æ›´æ–°å¡ç‰‡ä½ç½®ï¼ˆå †å æ•ˆæœï¼‰
         */
        updatePositions() {
            const cards = Array.from(this.container.children);
            const spacing = 15; // å¡ç‰‡é—´è·
            const maxCards = this.maxVisible;

            // ä¸ºæ¯å¼ å¡ç‰‡è®¡ç®—ä½ç½®
            cards.forEach((card, index) => {
                if (index >= maxCards) {
                    // è¶…å‡ºæœ€å¤§æ˜¾ç¤ºæ•°é‡çš„å¡ç‰‡ç›´æ¥éšè—
                    card.style.display = 'none';
                    return;
                }

                card.style.display = 'block';

                // è®¡ç®—åç§»é‡
                let offsetTop = index * (card.offsetHeight + spacing);

                // åº”ç”¨å¹³æ»‘è¿‡æ¸¡
                card.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
                // card.style.transform = `translateY(${offsetTop}px)`;

                // æ›´æ–°z-indexï¼Œæœ€æ–°çš„åœ¨æœ€ä¸Šé¢
                card.style.zIndex = 1000 - index;

                // å¦‚æœå¡ç‰‡å¤ªå¤šï¼Œé¡¶éƒ¨çš„å¡ç‰‡ä¼šé€æ¸å˜é€æ˜
                // if (cards.length > maxCards) {
                //     const opacity = Math.max(0, 1 - (cards.length - maxCards) * 0.1);
                //     card.style.opacity = opacity;
                // } else {
                //     card.style.opacity = 1;
                // }
            });
        }

        /**
         * æš‚åœæ¶ˆæ¯è®¡æ—¶ï¼ˆå½“é¼ æ ‡æ‚¬åœæ—¶ï¼‰
         */
        pauseNotification(id) {
            const notification = this.notifications.find(n => n.id === id);
            if (!notification) return;

            if (notification.timer) {
                clearTimeout(notification.timer);
                notification.timer = null;
            }

            if (notification.progressTimer) {
                clearInterval(notification.progressTimer);
                notification.progressTimer = null;
            }
        }

        /**
         * æ¢å¤æ¶ˆæ¯è®¡æ—¶ï¼ˆå½“é¼ æ ‡ç¦»å¼€æ—¶ï¼‰
         */
        resumeNotification(id) {
            const notification = this.notifications.find(n => n.id === id);
            if (!notification) return;

            // é‡æ–°å®‰æ’å®šæ—¶å™¨
            notification.timer = setTimeout(() => {
                this.closeNotification(id);
            }, notification.remainingTime);

            // é‡æ–°å¼€å§‹è¿›åº¦æ¡
            this.startProgressBar(notification);
        }

        /**
         * è·å–å½“å‰æ¶ˆæ¯æ•°é‡
         */
        getCount() {
            return this.notifications.length;
        }
    }

    // åˆå§‹åŒ–æ¶ˆæ¯ç®¡ç†å™¨
    const notificationManager = new NotificationManager();

    // æš´éœ²åˆ°å…¨å±€
    window.notificationManager = notificationManager;

    // ç™»å½•æ¬¢è¿ä¿¡æ¯
    let lastlogin = localStorage.getItem("lastlogin");
    lastlogin = JSON.parse(lastlogin);
    if (lastlogin && (!lastlogin.isNotify || lastlogin.isNotify === 0)) {
        notificationManager.show({
            title: 'ç™»å½•æˆåŠŸ',
            content: 'æ¬¢è¿æ‚¨ï¼Œ' + lastlogin.username,
            type: 'success',
            sender: 'ç³»ç»Ÿæ¶ˆæ¯',
            duration: 3000
        });
        lastlogin.isNotify = 1;
        window.localStorage.setItem("lastlogin", JSON.stringify(lastlogin));
        for (var i = 0; i < lastlogin.limit5.length; i++) {
            let msg = lastlogin.limit5[i];
            notificationManager.show({
                title: msg.title || 'æ–°æ¶ˆæ¯',
                content: msg.content || 'æ‚¨æœ‰ä¸€æ¡æ–°æ¶ˆæ¯',
                type: 'info',
                sender: 'ç³»ç»Ÿ',
                duration: 3000
            });
        }
        console.log(lastlogin.limit5);
    }
</script>
{if $Think.config.ws.open}
<script type="module">
    import WebSocketManager from '__CDN__/assets/js/backend/websocket.js';
    // åˆ›å»º WebSocket ç®¡ç†å™¨å®ä¾‹
    const wsManager = new WebSocketManager({
        url: 'ws://127.0.0.1:8085',
        debug: true,
        heartbeatInterval: 30000, // 30ç§’å¿ƒè·³
        heartbeatTimeout: 10000,  // 10ç§’è¶…æ—¶
        reconnectInterval: 3000,  // 3ç§’é‡è¯•
        maxReconnectAttempts: 10  // æœ€å¤šé‡è¯•10æ¬¡
    });

    // äº‹ä»¶ç›‘å¬
    wsManager.on('open', () => {
        updateStatus();
    });

    wsManager.on('close', (event) => {
        updateStatus();
    });

    wsManager.on('error', (error) => {
        updateStatus();
    });

    wsManager.on('message', (data) => {
        updateStatus();
        if (data.type && data.content) {
            // æ˜¾ç¤ºé€šçŸ¥
            notificationManager.show({
                title: data.title || 'æ–°æ¶ˆæ¯',
                content: data.content || 'æ‚¨æœ‰ä¸€æ¡æ–°æ¶ˆæ¯',
                type: data.type || 'info',
                sender: data.sender || 'ç³»ç»Ÿ',
                duration: data.duration || 3000 // 30ç§’
            });
        }
        if (data.count != undefined && data.count !== '') {
            // æ›´æ–°æ¶ˆæ¯è§’æ ‡æ˜¾ç¤º
            var $badge = $('.notification-link .navbar-badge');
            var $link = $('.notification-link');
            if (data.count > 0) {
                var displayCount = data.count > 99 ? '99+' : data.count;

                if ($badge.length > 0) {
                    // æ›´æ–°ç°æœ‰è§’æ ‡
                    $badge.text(displayCount);
                } else {
                    // åˆ›å»ºæ–°è§’æ ‡
                    $link.append('<span class="label label-danger navbar-badge">' + displayCount + '</span>');
                }
            } else {
                // ç§»é™¤è§’æ ‡
                if ($badge.length > 0) {
                    $badge.remove();
                }
            }
        }
    });

    wsManager.on('reconnect', ({ attempt }) => {
    });

    wsManager.on('heartbeat', ({ type }) => {
    });

    // å·¥å…·å‡½æ•°
    function updateStatus() {
        const status = wsManager.getStatus();
        var className = 'text-danger';
        var statusText = ' ç¦»çº¿';
        if (status.isConnected) {
            className = 'text-success';
            statusText = ' åœ¨çº¿';
        }
        console.log(statusText);
        const indicator = document.querySelector('.main-sidebar .user-panel .info .fa-circle');
        indicator.className = 'fa fa-circle ' + className;
        indicator.nextSibling.nodeValue = statusText;
    }
    // åˆå§‹çŠ¶æ€æ›´æ–°
    updateStatus();

    // å®šæ—¶æ›´æ–°çŠ¶æ€
    setInterval(updateStatus, 1000);
</script>
{/if}